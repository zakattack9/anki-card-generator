# anki-gen

A CLI tool for parsing EPUB files and generating Anki flashcards using AI.

## Overview

`anki-gen` extracts chapters from EPUB books and generates AI-powered Anki flashcards using the Gemini CLI. The tool:
1. Parses EPUB files into structured JSON with Markdown content
2. Generates both basic (Q&A) and cloze deletion flashcards
3. Outputs Anki-importable text files

## Installation

```bash
# Clone or navigate to the project directory
cd anki_gen

# Install in editable mode
pip install -e .
```

## Usage

### View Book Information

Display metadata and table of contents for an EPUB file:

```bash
anki-gen info book.epub
```

Output:
```
╭─────────────────── Book Information ───────────────────╮
│ The Everything American Government Book                │
│                                                        │
│ Author(s): Nick Ragone                                 │
│ Language: en                                           │
│ Publisher: F+W Media, Inc.                             │
│ Total Chapters: 35                                     │
╰────────────────────────────────────────────────────────╯

                Table of Contents
┏━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━┓
┃ #  ┃ Title                        ┃ Words ┃
┡━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━┩
│ 1  │ Title Page                   │    23 │
│ 2  │ Introduction                 │   547 │
│ 3  │ 1: The Birth of a Nation     │ 3,388 │
│ 4  │ 2: The Constitution          │ 2,755 │
│ ...│ ...                          │   ... │
└────┴──────────────────────────────┴───────┘
```

### Parse Chapters

#### Interactive Mode (Default)

When no `--chapters` flag is provided, the tool displays the table of contents and prompts for selection:

```bash
anki-gen parse book.epub
```

You'll see the TOC and can enter:
- Specific chapters: `1,3,5`
- Ranges: `1-5`
- Mixed: `1,3,5-10`
- All chapters: `all`

#### Direct Chapter Selection

Extract specific chapters without interactive prompts:

```bash
# Single chapters
anki-gen parse book.epub --chapters 1,3,5

# Chapter range
anki-gen parse book.epub --chapters 1-10

# Mixed selection
anki-gen parse book.epub --chapters 1,3,5-10,15

# All chapters
anki-gen parse book.epub --chapters all
```

#### Additional Options

```bash
# Specify output directory
anki-gen parse book.epub --chapters 1-5 --output-dir ./my_output

# Choose output format (markdown, text, or html)
anki-gen parse book.epub --chapters 1-5 --format text

# Force re-parse (ignore cache)
anki-gen parse book.epub --chapters 1-5 --force

# Quiet mode (suppress progress output)
anki-gen parse book.epub --chapters 1-5 --quiet
```

### Cache Management

The tool caches parsed EPUB structures to speed up repeated operations.

```bash
# List cached EPUBs
anki-gen cache list

# Clear all cached data
anki-gen cache clear
```

### Generate Flashcards

Generate AI-powered flashcards from parsed chapters using the Gemini CLI:

```bash
# Generate flashcards for all chapters
anki-gen generate ./book_chapters/

# Generate for specific chapters only
anki-gen generate ./book_chapters/ --chapters 1,3,5

# Generate for a range of chapters
anki-gen generate ./book_chapters/ --chapters 1-5

# Limit total cards per chapter
anki-gen generate ./book_chapters/ --max-cards 30

# Override the auto-generated deck name
anki-gen generate ./book_chapters/ --deck "My Custom Deck"

# Add extra global tags
anki-gen generate ./book_chapters/ --tag study --tag exam-prep

# Use a different Gemini model
anki-gen generate ./book_chapters/ --model gemini-2.5-pro

# Preview what would be processed (no API calls)
anki-gen generate ./book_chapters/ --dry-run
```

**Requirements:**
- [Gemini CLI](https://github.com/google-gemini/gemini-cli) must be installed and authenticated

**Output Files:**
For each chapter, generates a single combined file:
- `chapter_XXX_cards.txt` - Combined Basic + Cloze flashcards with Anki headers
- `chapter_XXX_meta.json` - Generation metadata

**Features:**
- Single API call per chapter (unified prompt generates both card types)
- AI decides optimal card type (Basic vs Cloze) for each fact
- No duplicate facts between card types
- Automatic deck hierarchy: `Book Title::Chapter NN - Chapter Title`
- Per-card topic tags generated by AI
- GUID support for re-importing/updating cards

## Output Format

Extracted chapters are saved in a folder next to the EPUB file (e.g., `bookname_chapters/`).

### Directory Structure

```
bookname_chapters/
├── manifest.json           # Book metadata and extraction info
├── chapter_001.json        # First extracted chapter
├── chapter_001_cards.txt   # Combined flashcards (after generate)
├── chapter_001_meta.json   # Generation metadata (after generate)
├── chapter_002.json        # Second extracted chapter
└── ...
```

### Chapter JSON Format

Each chapter file contains metadata and Markdown content optimized for AI processing:

```json
{
  "metadata": {
    "chapter_id": "ch001",
    "chapter_index": 0,
    "title": "1: The Birth of a Nation",
    "source_file": "text/part0009.html",
    "source_epub": "/path/to/book.epub",
    "extracted_at": "2025-01-05T10:30:00Z",
    "word_count": 3388,
    "character_count": 22331,
    "paragraph_count": 87
  },
  "content": "# The Birth of a Nation\n\nThe American government is an institution...",
  "format": "markdown",
  "ai_processing": null
}
```

### Manifest JSON Format

The manifest provides an overview of the extraction:

```json
{
  "book_title": "The Everything American Government Book",
  "authors": ["Nick Ragone"],
  "total_chapters": 35,
  "extracted_chapters": [0, 1, 2],
  "output_directory": "/path/to/bookname_chapters",
  "created_at": "2025-01-05T10:30:00Z",
  "chapters": [
    {
      "chapter_id": "ch001",
      "chapter_index": 0,
      "title": "1: The Birth of a Nation",
      "word_count": 3388
    }
  ]
}
```

### Flashcard Format

Generated flashcards use a combined format with Anki file headers (requires Anki 2.1.54+):

**Combined Cards** (`chapter_XXX_cards.txt`):
```
#separator:Pipe
#html:true
#deck:American Government::Chapter 01 - The Constitution
#tags:anki-gen american-government
#notetype column:1
#tags column:4
#guid column:5
#columns:Note Type|Field 1|Field 2|Tags|GUID
Basic|What are the three branches of government?|Legislative, Executive, and Judicial|branches constitution|ch001-001
Cloze|The Constitution was ratified in {{c1::1788}}.|Replaced the Articles of Confederation|constitution dates|ch001-002
Basic|Why did framers create checks and balances?|To prevent any single branch from dominating|checks-balances framers-intent|ch001-003
Cloze|The House has {{c1::435}} members.|Set by 1929 Reapportionment Act|house congress|ch001-004
```

**Import into Anki:**
1. Open Anki → File → Import
2. Select the `_cards.txt` file
3. Anki will auto-detect settings from file headers
4. Cards are automatically placed in the correct deck with tags

### Export Combined Cards

Combine all chapter card files into a single Anki-importable file:

```bash
# Export all chapters to single file
anki-gen export ./book_chapters/

# Specify custom output path
anki-gen export ./book_chapters/ --output flashcards.txt

# Quiet mode (suppress stats)
anki-gen export ./book_chapters/ --quiet
```

**Output:**
- Creates `all_cards.txt` (or custom filename) with all cards combined
- Preserves per-chapter deck hierarchy (`Book::Chapter 01`, `Book::Chapter 02`, etc.)
- Single import into Anki instead of multiple files
- Displays statistics summary showing cards per chapter

**Example Stats Output:**
```
╭──────────────────── Export Complete ────────────────────╮
│ Exported 450 cards from 10 chapter(s)                   │
│                                                         │
│ Basic cards: 280                                        │
│ Cloze cards: 170                                        │
│ Output file: ./book_chapters/all_cards.txt              │
╰─────────────────────────────────────────────────────────╯

           Per-Chapter Breakdown
┏━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━┳━━━━━━━┓
┃ #  ┃ Chapter                  ┃ Basic ┃ Cloze ┃ Total ┃
┡━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━╇━━━━━━━╇━━━━━━━┩
│ 1  │ Chapter 01 - The Birth.. │    28 │    17 │    45 │
│ 2  │ Chapter 02 - The Const.. │    32 │    18 │    50 │
│ ...│ ...                      │   ... │   ... │   ... │
├────┼──────────────────────────┼───────┼───────┼───────┤
│    │ Total                    │   280 │   170 │   450 │
└────┴──────────────────────────┴───────┴───────┴───────┘
```

## Workflow Example

A typical workflow for creating Anki flashcards:

```bash
# 1. Check what's in the book
anki-gen info "American Government.epub"

# 2. Extract chapters 1-3 for studying
anki-gen parse "American Government.epub" --chapters 1-3

# 3. Generate flashcards from the extracted chapters
anki-gen generate American_Government_chapters/

# 4. Export all cards to a single file
anki-gen export American_Government_chapters/

# 5. Import all_cards.txt into Anki
#    - Single file contains all chapters
#    - Each card goes to its chapter deck automatically
#    - Anki auto-detects deck, tags, and note types from headers

# 6. Later, come back and process more chapters
anki-gen parse "American Government.epub" --chapters 4-6
anki-gen generate American_Government_chapters/ --chapters 4-6
anki-gen export American_Government_chapters/  # Re-export with new chapters
```

## Caching

The tool automatically caches parsed EPUB structures in `.anki_gen_cache/` to speed up repeated operations:

- Cache is stored in the same directory as the EPUB file
- Cache invalidation uses file hash and modification time
- Use `--force` to bypass cache and re-parse
- Use `anki-gen cache clear` to remove all cached data

## Roadmap

Completed:
- [x] `anki-gen parse` - Extract chapters from EPUB files
- [x] `anki-gen generate` - AI-powered flashcard generation using Gemini CLI
- [x] `anki-gen export` - Combine multiple chapter flashcards into single file
- [x] Unified prompt (single API call generates both Basic and Cloze cards)
- [x] AI-optimized card type selection (no duplicate facts)
- [x] Anki file headers (auto deck, tags, GUID support)
- [x] Per-card topic tags
- [x] Streaming output display

Future features planned:
- [ ] Support for multiple AI providers (OpenAI, Anthropic, Claude)
- [ ] Customizable flashcard templates
- [ ] Batch processing of multiple EPUBs

## Requirements

- Python 3.10+
- [Gemini CLI](https://github.com/google-gemini/gemini-cli) (for `generate` command)
- Dependencies (installed automatically):
  - typer
  - ebooklib
  - beautifulsoup4
  - lxml
  - pydantic
  - rich
  - markdownify
